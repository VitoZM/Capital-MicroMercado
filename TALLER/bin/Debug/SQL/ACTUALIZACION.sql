
update venta set pago='EFECTIVO' WHERE IDVENTA=630
---------------
ALTER TABLE VENTA ADD CostoTarjeta float
update venta set costotarjeta=0
UPDATE LOTEVENTA SET Estado=1
----------------------
DECLARE @IDPRO INT,@CAN INT,@EMP VARCHAR(10),@COR VARCHAR(10),@PRECO FLOAT,@PREVE FLOAT,@PRO VARCHAR(20)
SET @EMP = 'VIVA'
SET @COR = '10 BS.'
SET @PRECO = 9.4
SET @PREVE = 10
SET @CAN = 0
SET @PRO = @EMP + ' ' + @COR
EXEC INSERTARPRODUCTO -1,'','TARJETA',@PRO,'1 UN.','TARJETAS',@PRECO,@PREVE,'','LADO ENTRADA'
SET @IDPRO = (SELECT MAX(IDPRODUCTO) FROM ALMACEN)
UPDATE ALMACEN SET CANTIDAD = @CAN WHERE IdProducto=@IDPRO
-------------------
insert into CAJATARJETA values(,110,85,613)-----------MODIFICAR VALORES SELECT * FROM CAJATARJETA
UPDATE CAJATARJETA SET MontoTotal=-353
-----------------------------
create PROC PAGARCREDITO @ID INT,@IDU INT
AS
	DECLARE @COTA FLOAT
	SET @COTA = (SELECT COSTOTARJETA FROM VENTA WHERE IDVENTA=@ID)
	UPDATE VENTA SET PAGO='EFECTIVO',Fecha=GETDATE(),Descripcion='DEUDA PAGADA',IDUSUARIO=@IDU WHERE IDVENTA=@ID
	UPDATE CAJATARJETA SET MONTOPRESTADO=MONTOPRESTADO-@COTA,MONTOEFECTIVO=MONTOEFECTIVO+@COTA
-----------------------------
ALTER VIEW LISTARCONTROL
AS
	SELECT CP.IDLOTE,P.CODIGO,P.Nombre + ' ' + P.MARCA AS PRODUCTO,CP.CANTIDAD,CP.EXPIRACION
	FROM CONTROLP CP INNER JOIN PRODUCTO P ON CP.IDPRODUCTO=P.IDPRODUCTO
	WHERE CP.Cantidad > 0
---------------------------------
ALTER PROC INSERTARVENTA @IDUSU INT,@CI VARCHAR(20),@NOM VARCHAR(60),@TEL VARCHAR(20),@COS FLOAT,@EFE FLOAT,@CAM FLOAT,@PA VARCHAR(10),@COTA FLOAT
AS
	DECLARE @IDCLI INT
	IF NOT EXISTS(SELECT * FROM CLIENTE WHERE CICLIENTE=@CI)
		INSERT INTO CLIENTE VALUES(@CI,@NOM,@TEL)
	SET @IDCLI = (SELECT IDCLIENTE FROM CLIENTE WHERE CICLIENTE=@CI)
	INSERT INTO VENTA VALUES(@IDUSU,@IDCLI,GETDATE(),@COS,@EFE,@CAM,'1','1',@PA,'',@COTA)
	IF @PA = 'CREDITO'
		UPDATE CAJATARJETA SET MONTOTOTAL=MONTOTOTAL+@COTA,MONTOPRESTADO=MONTOPRESTADO+@COTA
	ELSE
		UPDATE CAJATARJETA SET MONTOTOTAL=MONTOTOTAL+@COTA,MONTOEFECTIVO=MONTOEFECTIVO+@COTA
-----------------------------------
ALTER VIEW LISTARVENTASHOY
AS
	SELECT V.IDVENTA,U.IDUSUARIO,C.IDCLIENTE,U.NOMBRES + ' ' + U.APELLIDOS AS VENDEDOR,C.NOMBRES AS CLIENTE,C.CICLIENTE,CAST(DAY(V.FECHA) AS VARCHAR) + '/' + CAST(MONTH(V.FECHA) AS VARCHAR) + '/' + CAST(YEAR(V.FECHA) AS VARCHAR) + ' ' + CAST(convert(char(8), V.FECHA, 108) AS VARCHAR) AS FECHA,V.COSTOTOTAL,V.PAGO,V.EFECTIVO,V.CAMBIO,V.ESTADO,V.DESCRIPCION,V.COSTOTARJETA
	FROM VENTA V INNER JOIN USUARIO U ON V.IDUSUARIO=U.IDUSUARIO
				 INNER JOIN CLIENTE C ON V.IDCLIENTE=C.IDCLIENTE
	WHERE DAY(V.Fecha) = DAY(GETDATE()) AND MONTH(V.FECHA) = MONTH(GETDATE()) AND YEAR(V.FECHA) = YEAR(GETDATE())
----------YA DEBERIA PODER INSERTAR Y PAGAR CREDITO
CREATE PROC OBTENERTARJETASHOY @IDU INT
AS
	SELECT SUM(COSTOTARJETA) AS COSTOTARJETA
	FROM VENTA
	WHERE IDUSUARIO=@IDU AND ESTADO='1' AND PAGO='TARJETA'
		  AND DAY(FECHA)=DAY(GETDATE()) AND MONTH(FECHA)=MONTH(GETDATE()) AND YEAR(FECHA)=YEAR(GETDATE())
---------------------------
CREATE PROC OBTENERTARJETASEFECTIVOHOY @IDU INT
AS
	SELECT SUM(COSTOTARJETA) AS COSTOTARJETA
	FROM VENTA
	WHERE IDUSUARIO=@IDU AND ESTADO='1' AND PAGO='EFECTIVO'
		  AND DAY(FECHA)=DAY(GETDATE()) AND MONTH(FECHA)=MONTH(GETDATE()) AND YEAR(FECHA)=YEAR(GETDATE())
-------------------------------
CREATE PROC OBTENEREFECTIVOCAJATARJETA
AS
	SELECT MontoEfectivo
	FROM CAJATARJETA
--------------------------------
insert into DISTRIBUIDORA values('RUTERO ENTEL','','','TARJETAS')
--------------------------
CREATE PROC COMPRATARJETA @MON FLOAT,@EFE FLOAT,@DEU FLOAT
AS
	UPDATE CAJATARJETA SET MontoTotal=MontoTotal-@MON,MontoEfectivo=MontoEfectivo-@EFE,MONTODEUDA=MONTODEUDA+@DEU
---------------------------
CREATE PROC OBTENERMONTOTOTALTARJETAS
AS
	SELECT MontoTotal FROM CAJATARJETA
	---------------------------
CREATE PROC OBTENERMONTODEUDATARJETAS
AS
	SELECT MontoDEUDA FROM CAJATARJETA
	---------------------------
CREATE PROC OBTENERMONTOEFECTIVOTARJETAS
AS
	SELECT MontoEFECTIVO FROM CAJATARJETA
	---------------------------
CREATE PROC OBTENERMONTOPRESTADOTARJETAS
AS
	SELECT MontoPRESTADO FROM CAJATARJETA
-----------------------------
ALTER PROC DARBAJAVENTA @IDVEN INT,@DES VARCHAR(120)
AS
	DECLARE @COTA FLOAT,@PA VARCHAR(10)
	SELECT @COTA=COSTOTARJETA,@PA=PAGO FROM VENTA WHERE IdVenta=@IDVEN
	UPDATE VENTA SET ESTADO='0',DESCRIPCION=@DES WHERE IDVENTA=@IDVEN
	UPDATE LOTEVENTA SET ESTADO='0' WHERE IDVENTA=@IDVEN
	UPDATE CAJATARJETA SET MONTOTOTAL=MONTOTOTAL-@COTA
	IF @PA='CREDITO'
		UPDATE CAJATARJETA SET MONTOPRESTADO=MONTOPRESTADO-@COTA
	ELSE
		UPDATE CAJATARJETA SET MONTOEFECTIVO=MONTOEFECTIVO-@COTA
	SELECT * FROM LOTEVENTA WHERE IDVENTA=@IDVEN
----------------------
update CAJATARJETA set montodeuda=16.5
------------
--1.SE PUEDE IMPRIMIR
--2.SE PUEDE PAGAR DEUDAS
--3.SE DEBE ENSEÑAR NUEVO ARQUEO
--4.SE DEBE ENSEÑAR NUEVO BOTON TARJETAS
--APARTIR DE AQUI ACTUALIZAR
----------------------------------------------------
ALTER TABLE COMPRA ADD Descuento float,CostoFinal float
UPDATE COMPRA SET DESCUENTO=0,COSTOFINAL=CostoTotal
--------------------------------------------------------------
ALTER PROC OBTENERMONTOCOMPRASHOY @IDU INT
AS
	SELECT SUM(COSTOFINAL) FROM COMPRA
	WHERE IDUSUARIO=@IDU
	AND DAY(FECHA)=DAY(GETDATE()) AND MONTH(FECHA)=MONTH(GETDATE()) AND YEAR(FECHA)=YEAR(GETDATE())
---------------------------------------------------------------
ALTER VIEW LISTARCOMPRAS
AS
	SELECT IDCOMPRA,U.Nombres + ' ' + U.Apellidos AS VENDEDOR,D.Nombre AS DISTRIBUIDORA,(cast(DAY(C.FECHA) as varchar) + cast('/' as varchar) + cast(MONTH(C.FECHA) as varchar) + cast('/' as varchar) + cast(YEAR(C.FECHA) as varchar) + ' ' + cast(CONVERT(CHAR(8),C.FECHA, 108) as varchar)) AS FECHA,C.COSTOTOTAL,C.DESCRIPCION,C.DESCUENTO,C.COSTOFINAL
	FROM COMPRA C INNER JOIN USUARIO U ON C.IDUSUARIO=U.IDUSUARIO INNER JOIN DISTRIBUIDORA D ON D.IdDistribuidora = C.IdDistribuidora
---------------------------------------------------------------
ALTER VIEW LISTARCOMPRASHOY
AS
	SELECT C.IdCompra,U.NOMBRES + ' ' + U.APELLIDOS AS USUARIO,D.NOMBRE AS DISTRIBUIDORA,C.FECHA,C.COSTOTOTAL,C.DESCRIPCION,U.IdUsuario,C.Descuento,c.CostoFinal
	FROM COMPRA C INNER JOIN USUARIO U ON U.IDUSUARIO=C.IDUSUARIO
				  INNER JOIN DISTRIBUIDORA D ON D.IdDistribuidora=C.IdDistribuidora
	WHERE DAY(C.Fecha) = DAY(GETDATE()) AND MONTH(C.FECHA) = MONTH(GETDATE()) AND YEAR(C.FECHA) = YEAR(GETDATE())
---------------------------------------------------------------
ALTER PROC OBTENERCAPITALTARJETAS
AS
	SELECT SUM(A.CANTIDAD * P.PRECIOVENTA) AS CAPITAL
	FROM PRODUCTO P INNER JOIN ALMACEN A ON P.IdProducto=A.IdProducto
	WHERE NOMBRE='TARJETA'

UPDATE CAJATARJETA SET MontoDeuda=600
-----------------------------DESDE AQUI 28/04/2020
ALTER PROC LISTARDEUDASCLIENTE @CI VARCHAR(20)
AS
	SELECT V.IDVENTA,U.NOMBRES+' '+U.APELLIDOS AS VENDEDOR,C.Nombres AS CLIENTE,V.FECHA,V.CostoTotal,V.Pago,V.Efectivo,V.Cambio,V.Estado,c.CICliente,v.Descripcion,V.COSTOTARJETA
	FROM CLIENTE C INNER JOIN VENTA V ON C.IdCliente=V.IdCliente
					INNER JOIN USUARIO U ON U.IdUsuario=V.IdUsuario
	WHERE V.PAGO='CREDITO' AND CICliente =@CI
-----------------------------
ALTER VIEW LISTARCLIENTESDEUDAS
AS
SELECT C.CICliente,C.Nombres,SUM(V.CostoTotal) AS DEUDA
FROM CLIENTE C INNER JOIN VENTA V ON C.IdCliente=V.IdCliente
WHERE V.PAGO='CREDITO' AND CICliente <> '5676906' AND V.ESTADO='1'
GROUP BY C.CICliente,C.Nombres
-------------------------------------
CREATE PROC OBTENERULTIMAVENTA
AS
	DECLARE @IDV INT
	SET @IDV = (SELECT MAX(IDVENTA)FROM VENTA)
	SELECT V.IDVENTA,U.IDUSUARIO,C.IDCLIENTE,U.NOMBRES + ' ' + U.APELLIDOS AS VENDEDOR,C.NOMBRES AS CLIENTE,C.CICLIENTE,CAST(DAY(V.FECHA) AS VARCHAR) + '/' + CAST(MONTH(V.FECHA) AS VARCHAR) + '/' + CAST(YEAR(V.FECHA) AS VARCHAR) + ' ' + CAST(convert(char(8), V.FECHA, 108) AS VARCHAR) AS FECHA,V.COSTOTOTAL,V.PAGO,V.EFECTIVO,V.CAMBIO,V.ESTADO,V.DESCRIPCION,V.COSTOTARJETA
	FROM VENTA V INNER JOIN USUARIO U ON V.IDUSUARIO=U.IDUSUARIO
				 INNER JOIN CLIENTE C ON V.IDCLIENTE=C.IDCLIENTE
	WHERE IDVENTA=@IDV
---------------------------------------- NO SE PUEDE MODIFICAR EL NOMBRE DE RUTERO
SELECT * FROM LISTARCOMPRAS WHERE DISTRIBUIDORA='RUTERO'
----------------------------------------
create VIEW LISTARVENTASFINAL
AS
	SELECT V.IDVENTA,U.IDUSUARIO,C.IDCLIENTE,U.NOMBRES + ' ' + U.APELLIDOS AS VENDEDOR,C.NOMBRES AS CLIENTE,C.CICLIENTE,CAST(DAY(V.FECHA) AS VARCHAR) + '/' + CAST(MONTH(V.FECHA) AS VARCHAR) + '/' + CAST(YEAR(V.FECHA) AS VARCHAR) + ' ' + CAST(convert(char(8), V.FECHA, 108) AS VARCHAR) AS FECHA,V.COSTOTOTAL,V.PAGO,V.EFECTIVO,V.CAMBIO,V.ESTADO,V.DESCRIPCION,V.CostoTarjeta
	FROM VENTA V INNER JOIN USUARIO U ON V.IDUSUARIO=U.IDUSUARIO
				 INNER JOIN CLIENTE C ON V.IDCLIENTE=C.IDCLIENTE
------------------------------------------------------
CREATE PROC LISTARCOMPRASFINAL
AS
	select * from LISTARCOMPRAS
	where DISTRIBUIDORA<>'RUTERO'
	order by IDCOMPRA desc
------------------------------------------------
ALTER PROC INSERTARCOMPRA @COS FLOAT,@DES VARCHAR(200),@DIS VARCHAR(60),@DIR VARCHAR(60),@TEL VARCHAR(20),@CAT VARCHAR(25),@USU INT,@DESCU FLOAT,@COFI FLOAT,@FEC DATETIME
AS
	DECLARE @ID INT
	IF NOT EXISTS(SELECT * FROM DISTRIBUIDORA WHERE NOMBRE=@DIS)
		INSERT INTO DISTRIBUIDORA VALUES(@DIS,@DIR,@TEL,@CAT)
	SET @ID = (SELECT IDDISTRIBUIDORA FROM DISTRIBUIDORA WHERE NOMBRE=@DIS)
	INSERT INTO COMPRA VALUES(@FEC,@COS,1,@DES,@ID,@USU,@DESCU,@COFI)

-----------------------------------10/06/2020
CREATE VIEW LISTARPRODUCTOSCOMPRADOS
AS
	SELECT L.CANTIDAD,P.IdProducto,P.CODIGO,P.Nombre + ' ' + P.Marca + ' ' + P.Contenido AS PRODUCTO, C.Fecha
	FROM LOTE L INNER JOIN PRODUCTO P ON L.IdProducto=P.IdProducto INNER JOIN COMPRA C ON C.IdCompra=L.IdCompra
-------------------------------------
CREATE PROC LISTARPRODUCTOCOMPRADO @ID INT
AS
	SELECT * FROM LISTARPRODUCTOSCOMPRADOS WHERE IdProducto=@ID
-------------------------------------
exec LISTARPRODUCTOCOMPRADO 26