CREATE TABLE CAJATARJETA(
IdCaja int identity primary key,
MontoTotal float,
MontoPrestado float,
MontoEfectivo float,
MontoDeuda float
)
---------------
ALTER TABLE VENTA ADD CostoTarjeta float
update venta set costotarjeta=0
UPDATE LOTEVENTA SET Estado=1
----------------------
DECLARE @IDPRO INT,@CAN INT,@EMP VARCHAR(10),@COR VARCHAR(10),@PRECO FLOAT,@PREVE FLOAT,@PRO VARCHAR(20)
SET @EMP = 'ENTEL'
SET @COR = '30 BS.'
SET @PRECO = 27.3
SET @PREVE = 30
SET @CAN = 2
SET @PRO = @EMP + ' ' + @COR
EXEC INSERTARPRODUCTO -1,'','TARJETA',@PRO,'1 UN.','TARJETAS',@PRECO,@PREVE,'','LADO ENTRADA'
SET @IDPRO = (SELECT MAX(IDPRODUCTO) FROM ALMACEN)
UPDATE ALMACEN SET CANTIDAD = @CAN WHERE IdProducto=@IDPRO
-------------------
insert into CAJATARJETA values(100,10,90,0)-----------MODIFICAR VALORES SELECT * FROM CAJATARJETA
-----------------------------
CREATE VIEW LISTARCLIENTESDEUDAS
AS
SELECT C.CICliente,C.Nombres,SUM(V.CostoTotal) AS DEUDA
FROM CLIENTE C INNER JOIN VENTA V ON C.IdCliente=V.IdCliente
WHERE V.PAGO='CREDITO' AND CICliente <> '5676906' GROUP BY C.CICliente,C.Nombres
-----------------------------
CREATE PROC LISTARDEUDASCLIENTE @CI VARCHAR(20)
AS
	SELECT V.IDVENTA,U.NOMBRES+' '+U.APELLIDOS AS VENDEDOR,C.Nombres AS CLIENTE,V.FECHA,V.CostoTotal,V.Pago,V.Efectivo,V.Cambio,V.Estado,c.CICliente,v.Descripcion,V.COSTOTARJETA
	FROM CLIENTE C INNER JOIN VENTA V ON C.IdCliente=V.IdCliente
					INNER JOIN USUARIO U ON U.IdUsuario=V.IdUsuario
	WHERE V.PAGO='CREDITO' AND CICliente =@CI
-----------------------------
ALTER PROC PAGARCREDITO @ID INT,@IDU INT
AS
	DECLARE @COTA FLOAT
	SET @COTA = (SELECT COSTOTARJETA FROM VENTA WHERE IDVENTA=@ID)
	UPDATE VENTA SET PAGO='EFECTIVO',Fecha=GETDATE(),Descripcion='DEUDA PAGADA',IDUSUARIO=@IDU WHERE IDVENTA=@ID
	UPDATE CAJATARJETA SET MONTOPRESTADO=MONTOPRESTADO-@COTA,MONTOEFECTIVO=MONTOEFECTIVO+@COTA
-----------------------------
ALTER VIEW LISTARCONTROL
AS
	SELECT CP.IDLOTE,P.CODIGO,P.Nombre + ' ' + P.MARCA AS PRODUCTO,CP.CANTIDAD,CP.EXPIRACION
	FROM CONTROLP CP INNER JOIN PRODUCTO P ON CP.IDPRODUCTO=P.IDPRODUCTO
	WHERE CP.Cantidad > 0
---------------------------------
ALTER PROC INSERTARVENTA @IDUSU INT,@CI VARCHAR(20),@NOM VARCHAR(60),@TEL VARCHAR(20),@COS FLOAT,@EFE FLOAT,@CAM FLOAT,@PA VARCHAR(10),@COTA FLOAT
AS
	DECLARE @IDCLI INT
	IF NOT EXISTS(SELECT * FROM CLIENTE WHERE CICLIENTE=@CI)
		INSERT INTO CLIENTE VALUES(@CI,@NOM,@TEL)
	SET @IDCLI = (SELECT IDCLIENTE FROM CLIENTE WHERE CICLIENTE=@CI)
	INSERT INTO VENTA VALUES(@IDUSU,@IDCLI,GETDATE(),@COS,@EFE,@CAM,'1','1',@PA,'',@COTA)
	IF @PA = 'CREDITO'
		UPDATE CAJATARJETA SET MONTOTOTAL=MONTOTOTAL+@COTA,MONTOPRESTADO=MONTOPRESTADO+@COTA
	ELSE
		UPDATE CAJATARJETA SET MONTOTOTAL=MONTOTOTAL+@COTA,MONTOEFECTIVO=MONTOEFECTIVO+@COTA
-----------------------------------
ALTER VIEW LISTARVENTASHOY
AS
	SELECT V.IDVENTA,U.IDUSUARIO,C.IDCLIENTE,U.NOMBRES + ' ' + U.APELLIDOS AS VENDEDOR,C.NOMBRES AS CLIENTE,C.CICLIENTE,CAST(DAY(V.FECHA) AS VARCHAR) + '/' + CAST(MONTH(V.FECHA) AS VARCHAR) + '/' + CAST(YEAR(V.FECHA) AS VARCHAR) + ' ' + CAST(convert(char(8), V.FECHA, 108) AS VARCHAR) AS FECHA,V.COSTOTOTAL,V.PAGO,V.EFECTIVO,V.CAMBIO,V.ESTADO,V.DESCRIPCION,V.COSTOTARJETA
	FROM VENTA V INNER JOIN USUARIO U ON V.IDUSUARIO=U.IDUSUARIO
				 INNER JOIN CLIENTE C ON V.IDCLIENTE=C.IDCLIENTE
	WHERE DAY(V.Fecha) = DAY(GETDATE()) AND MONTH(V.FECHA) = MONTH(GETDATE()) AND YEAR(V.FECHA) = YEAR(GETDATE())
----------YA DEBERIA PODER INSERTAR Y PAGAR CREDITO
ALTER PROC OBTENERTARJETASHOY @IDU INT
AS
	SELECT SUM(COSTOTARJETA) AS COSTOTARJETA
	FROM VENTA
	WHERE IDUSUARIO=@IDU AND ESTADO='1' AND PAGO='TARJETA'
		  AND DAY(FECHA)=DAY(GETDATE()) AND MONTH(FECHA)=MONTH(GETDATE()) AND YEAR(FECHA)=YEAR(GETDATE())
---------------------------
CREATE PROC OBTENERTARJETASEFECTIVOHOY @IDU INT
AS
	SELECT SUM(COSTOTARJETA) AS COSTOTARJETA
	FROM VENTA
	WHERE IDUSUARIO=@IDU AND ESTADO='1' AND PAGO='EFECTIVO'
		  AND DAY(FECHA)=DAY(GETDATE()) AND MONTH(FECHA)=MONTH(GETDATE()) AND YEAR(FECHA)=YEAR(GETDATE())
-------------------------------
CREATE PROC OBTENEREFECTIVOCAJATARJETA
AS
	SELECT MontoEfectivo
	FROM CAJATARJETA
--------------------------------
insert into DISTRIBUIDORA values('RUTERO ENTEL','','','TARJETAS')
--------------------------
CREATE PROC COMPRATARJETA @MON FLOAT,@EFE FLOAT,@DEU FLOAT
AS
	UPDATE CAJATARJETA SET MontoTotal=MontoTotal-@MON,MontoEfectivo=MontoEfectivo-@EFE,MONTODEUDA=MONTODEUDA+@DEU
---------------------------
CREATE PROC OBTENERMONTOTOTALTARJETAS
AS
	SELECT MontoTotal FROM CAJATARJETA
	---------------------------
CREATE PROC OBTENERMONTODEUDATARJETAS
AS
	SELECT MontoDEUDA FROM CAJATARJETA
	---------------------------
CREATE PROC OBTENERMONTOEFECTIVOTARJETAS
AS
	SELECT MontoEFECTIVO FROM CAJATARJETA
	---------------------------
CREATE PROC OBTENERMONTOPRESTADOTARJETAS
AS
	SELECT MontoPRESTADO FROM CAJATARJETA
-----------------------------
ALTER PROC DARBAJAVENTA @IDVEN INT,@DES VARCHAR(120)
AS
	DECLARE @COTA FLOAT,@PA VARCHAR(10)
	SELECT @COTA=COSTOTARJETA,@PA=PAGO FROM VENTA WHERE IdVenta=@IDVEN
	UPDATE VENTA SET ESTADO='0',DESCRIPCION=@DES WHERE IDVENTA=@IDVEN
	UPDATE LOTEVENTA SET ESTADO='0' WHERE IDVENTA=@IDVEN
	UPDATE CAJATARJETA SET MONTOTOTAL=MONTOTOTAL-@COTA
	IF @PA='CREDITO'
		UPDATE CAJATARJETA SET MONTOPRESTADO=MONTOPRESTADO-@COTA
	ELSE
		UPDATE CAJATARJETA SET MONTOEFECTIVO=MONTOEFECTIVO-@COTA
	SELECT * FROM LOTEVENTA WHERE IDVENTA=@IDVEN
----------------------
update CAJATARJETA set montodeuda=16.5
------------
--1.SE PUEDE IMPRIMIR
--2.SE PUEDE PAGAR DEUDAS
--3.SE DEBE ENSEÑAR NUEVO ARQUEO
--4.SE DEBE ENSEÑAR NUEVO BOTON TARJETAS